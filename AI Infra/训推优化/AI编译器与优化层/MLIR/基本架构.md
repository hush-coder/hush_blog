# 基本架构

```cpp
#include "mlir/IR/MLIRContext.h"
#include "mlir/IR/Module.h"
#include "mlir/Pass/Pass.h"
#include "mlir/Pass/PassManager.h"
#include "mlir/Dialect/Arith/IR/Arith.h"
#include "mlir/Dialect/Func/IR/FuncOps.h"

int main() {
  // 1. 创建Context（城市管理局）
  MLIRContext context;
  
  // 2. 加载方言（注册功能区）
  context.getOrLoadDialect<arith::ArithDialect>();
  context.getOrLoadDialect<func::FuncDialect>();
  
  // 3. 创建Module（城市规划）
  OwningOpRef<ModuleOp> module = ModuleOp::create(UnknownLoc::get(&context));
  
  // 4. 创建Builder（施工队）
  OpBuilder builder(&context);
  
  // 5. 在Module中创建函数（建筑项目）
  auto funcType = builder.getFunctionType({}, {});
  auto func = func::FuncOp::create(UnknownLoc::get(&context), "main", funcType);
  module->push_back(func);
  
  // 6. 创建基本块（楼层）
  Block *entryBlock = func.addEntryBlock();
  builder.setInsertionPointToStart(entryBlock);
  
  // 7. 创建操作（安装设备）
  Value a = builder.create<arith::ConstantOp>(
      UnknownLoc::get(&context),
      builder.getI32IntegerAttr(10)
  );
  Value b = builder.create<arith::ConstantOp>(
      UnknownLoc::get(&context),
      builder.getI32IntegerAttr(20)
  );
  Value sum = builder.create<arith::AddIOp>(
      UnknownLoc::get(&context),
      a, b
  );
  
  // 8. 创建返回操作
  builder.create<func::ReturnOp>(UnknownLoc::get(&context), sum);
  
  // 9. 打印原始IR
  module->dump();
  
  // 10. 创建Pass管理器（装修调度中心）
  PassManager pm(&context);
  
  // 11. 添加Pass（安排装修队）
  pm.addNestedPass<func::FuncOp>(createCanonicalizerPass());
  
  // 12. 运行Pass（开始装修）
  if (failed(pm.run(*module))) {
    llvm::errs() << "Pass运行失败\n";
    return 1;
  }
  
  // 13. 打印优化后的IR
  llvm::errs() << "\n优化后:\n";
  module->dump();
  
  return 0;
}
```

## Context
## Module
## Operation
## Dialect
## Pass
## 计算图
## Several points
### Module和Op中的Dialect
Module固定为内置Dialect
Op的Dialect类型是与生俱来的
Lowering过程其实就是将原Dialect类型的Op删掉，再重写为另一类型Dialect的Op
### 算子、操作、函数与内核
- 函数function是为了实现某一功能的一系列操作operation
- 算子operator是操作operation的抽象表示语义单元，可以用来构建计算图map从而进行一些优化
- 操作operation是算子operator的具体特化实现单元，是具体MLIR实现
- 内核kernel是操作operation的执行单元，所谓的__global__函数，是具体cuda实现