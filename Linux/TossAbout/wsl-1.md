# TossAbout Linux - WSL篇（1）

## 摘要

本文档介绍在Windows 11宿主机上配置WSL（Ubuntu 24 LTS）代理访问的解决方案，以及Clash for Windows的详细配置说明。

## 目录

- [本人配置](#本人配置)
- [问题描述](#问题描述)
- [Clash详解](#clash详解)
- [尝试过的方案](#尝试过的方案)
- [怎么解决？](#怎么解决)
- [为什么ping不通google](#为什么ping不通google)
- [为什么ssh依旧不行](#为什么ssh依旧不行)

## 本人配置

- **宿主机**: Windows 11 轻薄本
- **WSL**: Ubuntu 24 LTS
- **代理软件**: Clash for Windows

## 问题描述

在宿主机上可以使用代理访问，但在WSL上无法正常使用代理。

## Clash详解

> **注意**: 急着解决问题的用户可以直接跳过此部分，查看[尝试过的方案](#尝试过的方案)

### 主要组件

#### 1. 常规 (General)

这里是软件最核心的开关和连接状态控制区。

- **开关按钮**: 最大的圆形按钮，用于启动/停止 Clash 代理服务
- **系统代理 (System Proxy)**: 控制是否修改Windows系统的代理设置
  - 开启后，浏览器和其他支持系统代理的软件才会通过Clash上网
  - 通常需要保持开启
- **开机启动 (Start with Windows)**: 设置Clash是否随操作系统启动
- **混合端口 (Mixed Port)**: Clash监听一个端口，同时提供HTTP、SOCKS5代理服务
  - 通常不需要改动
- **允许局域网连接 (Allow LAN)**: 开启后，同一局域网下的其他设备可以将你的电脑作为代理服务器使用

#### 2. 代理 (Proxies)

这是选择节点和代理模式的核心页面。

##### 策略组 (Proxy Groups)

| 模式 | 说明 | 使用场景 |
|------|------|----------|
| **手动选择 (Select)** | 手动从该组中选择一个节点使用 | 需要固定节点的场景 |
| **故障转移 (Fallback)** | 自动选择组内第一个可用的节点，失败时切换到下一个 | 追求稳定性的场景 |
| **负载均衡 (Load Balance)** | 将流量随机分配给组内的不同节点 | 提升速度（不建议用于需要稳定会话的场景） |
| **延迟测试 (URL-Test)** | 自动定时测试组内所有节点的延迟，选择延迟最低的节点 | **最常用，推荐使用** |
| **全局规则 (GLOBAL)** | 所有流量都走代理，不经过任何规则判断 | 通常不建议使用，速度慢且费流量 |
| **直连 (DIRECT)** | 所有流量都不走代理，直接连接 | 相当于关闭代理的效果 |
| **规则 (Rule)** | 根据配置文件设定的规则智能分流流量 | **最常用和推荐的模式** |

#### 3. 配置 (Profiles)

用于管理你的订阅链接和配置文件。

- **列表**: 显示你添加的所有订阅配置
- **刷新按钮** (带箭头): 从远程服务器更新选中的订阅链接
- **下载按钮** (云朵带箭头): 从远程URL添加新的订阅链接
- **编辑按钮** (铅笔): 编辑当前选中的配置文件（高级用户功能）
- **设置图标**: 设置订阅更新间隔、是否启用代理更新等

#### 4. 日志 (Logs)

显示Clash内核运行的详细日志，用于高级调试。

#### 5. 连接 (Connections)

显示当前所有活动的网络连接，可以手动中断某个连接。

#### 6. 调试 (Debug)

主要用于开发者或高级用户调试配置文件，普通用户很少使用。

#### 7. 设置 (Settings)

软件本身的各项设置。

- **常规设置**: 语言、主题、软件更新等
- **Clash内核**: 显示当前使用的Clash核心版本
- **系统代理设置**: 手动修改Clash设置的系统代理参数
- **TUN模式**: 接管操作系统整个网络栈的流量，实现全局代理

### 高级选项

#### 1. UWP应用联网限制解除工具

**是什么**: 用于解除Windows系统对UWP应用的网络环路限制的工具。

**为什么需要**:
- Windows默认禁止UWP应用将网络流量发送到本机（127.0.0.1）
- Clash的工作原理正是在本机开启代理服务器
- 默认情况下，UWP应用无法连接到Clash的代理

**作用**: 将指定的UWP应用加入到豁免列表中，允许它们访问本机代理。

#### 2. 虚拟网卡安装 (TAP Mode / Driver)

**是什么**: 在操作系统内核层安装虚拟网络接口卡。

**为什么需要**: 实现TUN/TAP模式的基础，Clash需要通过虚拟网卡拦截和重定向网络流量。

**作用**: 安装驱动后，Clash才能使用TUN/TAP模式。

#### 3. 服务模式 (Service Mode)

**是什么**: 让Clash以Windows系统服务方式运行的模式。

**为什么需要**:
- 普通应用程序权限低于系统服务
- 使用TUN模式或防火墙功能时需要高权限
- 避免每次启动时弹出UAC窗口

**作用**: 以服务模式运行后，Clash获得所需的高权限，可以无弹窗启用高级功能。

#### 4. TUN模式 (TUN Mode)

**是什么**: 全局的、基于虚拟网卡的流量接管模式。

**与"系统代理"的区别**:

| 特性 | 系统代理 (System Proxy) | TUN模式 |
|------|------------------------|---------|
| **工作原理** | 修改Windows系统设置，告知系统将流量发送到127.0.0.1:7890 | 在内核层创建虚拟网卡，直接拦截几乎所有网络流量 |
| **接管范围** | 仅对支持系统代理设置的应用程序有效 | 对几乎所有应用程序都有效，包括命令行、游戏、UWP应用等 |
| **兼容性** | 好，是标准方式 | 极好，是"强力"模式 |
| **性能** | 开销小，效率高 | 开销稍大，但现代硬件基本无感 |

**作用**: 解决"系统代理"模式无法管束的应用程序的联网问题，实现真正的全局代理。

#### 5. 混合配置 (Mixin)

**是什么**: 在不直接修改原始配置文件的情况下，动态注入或覆盖某些设置。

**为什么需要**: 主配置文件来自订阅链接，每次更新都会覆盖本地修改。

**作用**: 将个性化配置与订阅获取的配置文件混合，生成最终生效的配置。

#### 6. 系统代理 (System Proxy)

**是什么**: Clash最基础的工作方式，在电脑上开启代理服务器并修改Windows系统代理设置。

**作用**: 让尊重系统代理设置的软件流量自动流向Clash。

**注意**: 这是应用层设置，可以被程序忽略或覆盖。

#### 7. 允许局域网连接 (Allow LAN)

**是什么**: 允许局域网内的其他设备通过当前电脑作为网关上网。

**作用**: 实现共享代理。

**绑定地址选项**:
- `0.0.0.0`: 监听所有网络接口（默认值，最常用）
- `127.0.0.1`: 只允许本机连接
- 特定IP地址: 只监听指定的网络接口

## 尝试过的方案

### .wslconfig配置

#### 方案

在C盘根目录创建`.wslconfig`文件：

```ini
[experimental]
autoMemoryReclaim=gradual
networkingMode=mirrored
dnsTunneling=true
firewall=true
autoProxy=true
```

***以前有用，现在不行了***

#### 详解

**networkingMode=mirrored (核心冲突点)**:

**目标**: 尝试让 WSL2 拥有和 Windows 完全相同的网络栈，消除 NAT，使得 WSL2 直接使用主机的网络接口。这理论上应该让 WSL2 也能看到 Windows 的 127.0.0.1。

**现实**: 这个功能是"实验性"的，并不完美。它可能会与 Clash TUN 模式创建的虚拟网卡发生冲突。TUN 模式依赖于一个虚拟网卡来接管流量，而 mirrored 模式可能无法正确地镜像这个虚拟设备到 WSL2 中，导致 WSL2 的流量无法被 Clash 正确捕获。

**autoProxy=true**:

**目标**: 让 WSL2 自动继承 Windows 的系统代理设置（就是你可以在 Windows 设置里看到的那个 http://127.0.0.1:7890）。

**问题**: 这个功能同样依赖 mirrored 模式的稳定性。如果 mirrored 模式工作不正常，autoProxy 也会失效。此外，即使它能工作，它也只对"系统代理"有效。如果你主要使用 TUN 模式，那么系统代理设置本身可能就是关闭的，这个功能也就无从谈起了。

**dnsTunneling=true 和 firewall=true**:

这些功能也会改变 WSL2 的网络处理方式，可能与 Clash 的 DNS 劫持和防火墙规则（如果启用了 Clash 的增强模式）产生不可预见的交互，进一步导致网络不稳定。

**为什么是"有时候"不管用？**

- **冷启动顺序问题**: 如果你先打开 Clash 并开启 TUN 模式（创建了虚拟网卡），然后启动 WSL，WSL 的 mirrored 模式可能会成功识别到该网卡。
- **热切换问题**: 反之，如果你在 WSL 运行后再切换 Clash 的模式（比如开关 TUN 模式），mirrored 网络可能无法动态更新，导致连接断开。
- **网络环境变化**: 从 Wi-Fi 切换到有线网，或者电脑睡眠后唤醒，都可能触发网络栈的重置，而这个重置过程在 mirrored 模式下可能不完美，导致 WSL 无法恢复正确的网络路径。

### ~/.bashrc获取虚拟IP

#### 方案

先宿主机`ipconfig`，获取到 ***以太网适配器 vEthernet (WSL (Hyper-V firewall))*** 的ipv4的ip地址

***就跟没开代理一样***

## 怎么解决？

这里就比较复杂

**在旧的windows里面**WSL2 在一个虚拟交换机下运行，拥有一个独立的私有网段（如 172.x.x.x）。你的 Windows 主机在这个网络中扮演"路由器"和"网关"的角色。

Clash 在 Windows 端运行，并开启代理服务（默认监听 127.0.0.1:7890 和 7891）。

通过开启 Clash 的 允许局域网连接 选项，并将绑定地址设置为 0.0.0.0，Clash 的代理服务就不再只监听本机回环地址 (127.0.0.1)，而是监听主机上所有网络接口的请求，包括 WSL2 用来与 Windows 通信的那个虚拟网卡。

在 WSL2 内部，我们通过环境变量（http_proxy, all_proxy）明确告诉各种命令行工具（如 curl, wget, git, pip, apt）："请不要直接访问网络，请把所有的请求都发送到 $host_ip:7890 这个地址去"，而这个 $host_ip 正好就是 Windows 主机的 IP。

于是，WSL2 内的网络请求被发送到 Windows 主机的 Clash 代理端口，Clash 接收到请求后，再根据其规则（Rule）决定是直连还是通过代理节点转发。

### 关于为什么绑定地址是0.0.0.0

这涉及到网络编程中"监听地址"的概念。你可以把它想象成一家公司前台电话的分机号码。

**127.0.0.1 (本地回环地址)**:

**比喻**: 这只相当于一个内部员工专线。只有公司内部的人（即Windows操作系统本身）可以用这个电话找到前台（Clash）。

**技术含义**: Clash 只监听来自本机内部的连接请求。WSL2 虽然运行在你的电脑上，但在网络层面它被视作一个独立的、外部设备，它无法通过这个"内部专线"联系到 Clash。

**0.0.0.0**:

**比喻**: 这相当于一个总机号码，它绑定了公司所有的对外电话线（即主机上所有的网络接口）。无论是内部员工用内线打进来，还是外部客户用外线打进来，只要拨这个总机号，都会接到前台（Clash）。

**技术含义**: Clash 监听主机上所有网络接口（网卡）的连接请求。这包括：

- 你的物理网卡（如 Wi-Fi 或以太网，IP 可能是 192.xxx.1.xxx）
- 你的回环网卡 (127.0.0.1)
- 为 WSL2 创建的虚拟网卡 (IP 可能是 172.xx.xx.1)

**结论**: 只有将绑定地址设置为 0.0.0.0，WSL2 这个"外部设备"才能通过网络连接到运行在 Windows 上的 Clash 代理服务。127.0.0.1 会导致 WSL2 被拒绝访问。

### 关于如果 WSL2 的 nameserver 无法自动生成怎么办？

/etc/resolv.conf 文件由 WSL 系统自动生成，其目的是告诉 WSL2 如何解析域名（即使用哪个 DNS 服务器）。它的首选 DNS 服务器被设置为 Windows 主机的 IP，因为 Windows 主机充当着 WSL2 的"网关"和"DNS 中转器"。

如果这个文件没有自动生成或内容错误，通常意味着 WSL2 的网络子系统出现了问题。以下是系统的排查和解决方法：

**检查并禁用 resolv.conf 自动生成覆盖**

WSL 有一个配置项，如果被启用，会阻止自动生成 resolv.conf。

在 WSL 中编辑 `/etc/wsl.conf` 文件：

```ini
[network]
generateResolvConf = false
```

**解决方案**: 要么删除这行配置，要么将其改为 `generateResolvConf = true`，然后保存文件。

必须再次执行 `wsl --shutdown` 并重启 WSL，更改才会生效。

### Windows新特性

我的nameserver内容是`nameserver 10.xxx.xxx.xx`

但是我的宿主机ipconfig输出是`172.xxx.xx.xxx`

**为什么 nameserver 是 10.255.255.254 而不是 172.21.80.1？**

这是因为从 Windows 11 22H2 及更高版本开始，微软为 WSL2 引入了一种名为 "镜像网络模式"（Mirrored Networking Mode） 的新型网络架构。您看到的 10.255.255.254 正是这个新模式的核心组件。

**在传统模式（您期望的模式）下**:

- WSL2 使用 NAT 网络
- Windows 主机在 WSL2 的虚拟网络中有一个 IP（如 172.21.80.1）
- WSL2 将 172.21.80.1 作为其网关和 DNS 服务器（写入 /etc/resolv.conf）

**在新的镜像模式下**:

- Microsoft 引入了一个轻量级虚拟机 WslService 来管理网络
- 这个虚拟机在 WSL2 内部呈现为一个特殊的 DNS 服务器，其地址固定为 10.255.255.254
- WSL2 内部的 DNS 请求首先发送给 10.255.255.254，然后由这个 WslService 虚拟机转发到 Windows 主机的实际 DNS 服务器（可能是 192.168.110.1 或你配置的其他 DNS）

所以，您的 nameserver 10.255.255.254 是正确的，并且是更新、更推荐的网络模式。 它提供了更好的本地网络兼容性和 DNS 解析体验。

**那么，`export host_ip=$(grep -oP '(?<=nameserver\s)\S+' /etc/resolv.conf | head -1)` 还靠谱吗？**

答案是：**不靠谱了**，在这个新模式下需要修改。

这个命令的目的是找到 Windows 主机的 IP，以便将代理流量发送过去。但现在它找到的是 10.255.255.254，这是一个 WSL2 内部的、特殊的地址，Clash 并不在那里运行。

我们需要一种新的、更可靠的方法来获取宿主机可达的 IP 地址。

**新的、可靠的解决方案**

在新旧两种网络模式下都能稳定工作的方法是：使用 Windows 主机的主机名。

Windows 主机在 WSL2 中有一个固定的主机名：`hostname.mshome.net`（其中 hostname 是您电脑的名称）。

您可以按照以下步骤修改您的配置：

**在 WSL2 中获取您电脑的主机名**:

在 WSL2 终端中运行：

```bash
cat /etc/hosts | grep -i "mshome.net" | awk '{print $1}'
```

或者，更直接地，运行：

```bash
hostname=$(hostname).mshome.net
echo $hostname
```

这会输出类似 `MyComputerName.mshome.net` 的字符串。

**修改您的 ~/.bashrc 或 ~/.zshrc 配置**:

将之前获取 IP 的命令，替换为使用主机名的方式。

```bash
# 方法一：使用 hosts 文件中的IP（更通用）
# 这行命令会从 /etc/hosts 中提取出指向 .mshome.net 的IP地址，通常这就是宿主机的IP
export host_ip=$(grep -oP '^\S+(?=\s+.*\.mshome\.net)' /etc/hosts | head -1)

# 方法二：直接使用主机名（推荐）
export host_name=$(hostname).mshome.net

# 设置代理环境变量
export HTTP_PROXY="http://$host_name:7890"
export HTTPS_PROXY="http://$host_name:7890"
export ALL_PROXY="socks5://$host_name:7891"
```

**让配置生效**:

```bash
source ~/.bashrc  # 或 ~/.zshrc
```

**测试是否成功**:

```bash
# 测试是否能解析主机名
ping -c 4 "$host_name"

# 测试代理
curl -v http://ip.sb
```

**为什么使用主机名 *.mshome.net 更可靠？**

因为无论 WSL2 的网络架构如何变化（NAT 模式还是新的镜像模式），Microsoft 都会保证在 WSL2 的 /etc/hosts 文件中有一条记录，将您Windows主机的主机名映射到一个正确的、可访问的 IP 地址。使用主机名，系统会自动为您完成这个解析过程，您无需关心底层的 IP 到底是什么。

**总结**

- 您没看错：nameserver 10.255.255.254 是 WSL2 新网络模式的特征，是正常的
- 旧命令已失效：基于 /etc/resolv.conf 获取 IP 的方法在新模式下不再适用
- 新方法更强大：使用 `$(hostname).mshome.net` 这个主机名来配置代理，是当前最可靠、兼容性最好的方法，因为它由 WSL2 官方机制保证总能正确指向您的 Windows 主机

## 为什么ping不通google

ping 命令使用 ICMP 协议来测试网络连通性。ICMP 协议通常被防火墙、代理服务器（如 Clash）或中间网络设备出于安全原因策略性地丢弃或忽略。

**代理不处理 ICMP**: 你配置的代理（Clash）主要处理 TCP 或 UDP 流量（如 HTTP/HTTPS），默认不代理 ICMP 协议。当你 ping github.com 时，这个 ICMP 请求并没有通过 Clash 代理发送出去，而是试图直接连接。如果本地网络到 GitHub 的 ICMP 通路不畅（这很常见），就会超时。

**ICMP 可能被丢弃**: 很多服务器和网络为了安全或减少无关流量，会配置为不响应 ICMP Echo 请求。

✅ **解决方案**:

**使用 curl 测试网络连通性**: 这是更可靠的方法。因为 curl 使用 HTTP/HTTPS 协议（TCP），而这类流量会被你的代理设置正确引导。

尝试：

```bash
curl -v https://github.com
```

如果这条命令能返回数据（即使是 301 跳转信息），就说明你的网络连接、DNS 解析（通过 hush.mshome.net）和代理配置都是完全正常的。Web 访问和命令行的 git 操作依赖的是 TCP 连接，而不是 ICMP。因此，只要 curl 或 git clone 能工作，你的网络就是通的。

**（可选）尝试开启 Clash 的 TUN 模式**: TUN 模式可以在系统层面接管几乎所有网络流量（包括 ICMP）。启用并正确配置 TUN 模式后，ping 命令的流量也可能被代理，从而成功。但这需要额外的配置步骤，且不是必须的。

## 为什么ssh依旧不行

要让 SSH 通过代理连接 GitHub，你需要单独配置 SSH 的代理设置。以下是具体步骤：

**编辑 SSH 配置文件**:

打开或创建 `~/.ssh/config` 文件，添加以下内容：

```bash
Host github.com
   User git
   Hostname github.com
   Port 22
   ProxyCommand nc -X connect -x 192.168.137.1:7890 %h %p
```

如果 nc（Netcat）不支持 -X 参数（如旧版本），可以改用 connect 工具：

```bash
ProxyCommand connect -H 192.168.137.1:7890 %h %p
```

**安装 connect**:

```bash
sudo apt-get install connect-proxy
```

**测试 SSH 连接**:

运行以下命令测试：

```bash
ssh -T git@github.com
```